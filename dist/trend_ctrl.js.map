{"version":3,"sources":["../src/trend_ctrl.js"],"names":["MetricsPanelCtrl","_","kbn","TimeSeries","TrendCtrl","$scope","$injector","$rootScope","panelDefaults","bgColor","prefix","postfix","valueName","format","prefixFontSize","valueFontSize","postfixFontSize","trend","show","signFontSize","unitFontSize","showDiff","colors","sign","defaultsDeep","panel","events","on","onDataReceived","bind","onDataError","onInitEditMode","onPanelTeardown","render","data","percent","valueNameOptions","value","text","err","console","log","dataList","series","map","seriesHandler","setValues","fontSizes","unitFormats","getUnitFormats","addEditorTab","$timeout","cancel","nextTickPromise","panelColorIndex","color","seriesData","datapoints","alias","target","flotpairs","getFlotPairs","nullPointMode","length","lastPoint","last","lastValue","isArray","valueRounded","valueFormatted","isString","escape","formatFunc","valueFormats","stats","decimalInfo","getDecimalsForValue","decimals","scaledDecimals","roundValue","scopedVars","extend","label","getTrendValue","current","original","increase","Math","abs","parseInt","toFixed","increaseFormatted","increaseRounded","subItem","refresh","isNumber","delta","dec","floor","LN10","magn","pow","norm","size","result","max","scope","elem","$panelContainer","find","$valueContainer","$prefixContainer","$trendContainer","$signContainer","$unitContainer","$diffContainer","$trendValueContainer","html","css","removeAttr","hasOwnProperty","templateUrl"],"mappings":"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","file":"trend_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport TimeSeries from 'app/core/time_series';\n// import rendering from './rendering';\nimport './css/trend-panel.css!';\n\nexport class TrendCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n\n    const panelDefaults = {\n      bgColor: null,\n      prefix: '',\n      postfix: '',\n      valueName: 'avg',\n      format: 'none',\n      prefixFontSize: '50%',\n      valueFontSize: '80%',\n      postfixFontSize: '50%',\n      trend: {\n        show: true,\n        valueFontSize: '80%',\n        signFontSize: '70%',\n        unitFontSize: '50%',\n        showDiff: false,\n        colors: ['#d44a3a', '#666666', '#299c46'],\n        sign: ['▼', '▶', '▲'],\n      },\n    };\n\n    _.defaultsDeep(this.panel, panelDefaults);\n\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\n    this.events.on('panel-initialized', this.render.bind(this));\n\n    this.data = {trend: {percent: 0, sign: 0}};\n\n    this.valueNameOptions = [\n      { value: 'min', text: 'Min' },\n      { value: 'max', text: 'Max' },\n      { value: 'avg', text: 'Average' },\n      { value: 'current', text: 'Current' },\n      { value: 'total', text: 'Total' },\n      { value: 'name', text: 'Name' },\n      { value: 'first', text: 'First' },\n      { value: 'delta', text: 'Delta' },\n      { value: 'diff', text: 'Difference' },\n      { value: 'range', text: 'Range' },\n      { value: 'last_time', text: 'Time of last point' },\n    ];\n  }\n\n  //\n  // Event Handling\n  //\n  onDataError(err) {\n    console.log(err);\n    this.onDataReceived([]);\n  }\n\n  onDataReceived(dataList) {\n    const data = {};\n\n    this.series = dataList.map(this.seriesHandler.bind(this));\n    this.setValues(data);\n\n    this.data = data;\n    this.render();\n  }\n\n  onInitEditMode() {\n    this.fontSizes = ['20%', '30%', '50%', '70%', '80%', '100%', '110%', '120%', '150%', '170%', '200%'];\n    this.unitFormats = kbn.getUnitFormats();\n    this.addEditorTab('Options', 'public/plugins/trend-panel/editor.html', 2);\n  }\n\n  onPanelTeardown() {\n    this.$timeout.cancel(this.nextTickPromise);\n  }\n\n  onTrendColorChange(panelColorIndex) {\n    return color => {\n      this.panel.trend.colors[panelColorIndex] = color;\n      this.render();\n    };\n  }\n\n  //\n  // Data Handling\n  //\n  seriesHandler(seriesData) {\n    const series = new TimeSeries({\n      datapoints: seriesData.datapoints || [],\n      alias: seriesData.target,\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    return series;\n  }\n\n  setValues(data) {\n    data.flotpairs = [];\n\n    console.log(`${this.panel.prefix} > setValues()`)\n    console.log(this.series)\n\n    if (this.series && this.series.length > 0) {\n      const lastPoint = _.last(this.series[0].datapoints);\n      const lastValue = _.isArray(lastPoint) ? lastPoint[0] : null;\n\n      if (this.panel.valueName === 'name') {\n        data.value = 0;\n        data.valueRounded = 0;\n        data.valueFormatted = this.series[0].alias;\n      } else if (_.isString(lastValue)) {\n        data.value = 0;\n        data.valueFormatted = _.escape(lastValue);\n        data.valueRounded = 0;\n      } else if (this.panel.valueName === 'last_time') {\n        const formatFunc = kbn.valueFormats[this.panel.format];\n        data.value = lastPoint[1];\n        data.valueRounded = data.value;\n        data.valueFormatted = formatFunc(data.value, 0, 0);\n      } else {\n        data.value = this.series[0].stats[this.panel.valueName];\n        data.flotpairs = this.series[0].flotpairs;\n\n        const decimalInfo = this.getDecimalsForValue(data.value);\n        const formatFunc = kbn.valueFormats[this.panel.format];\n        data.valueFormatted = formatFunc(data.value, decimalInfo.decimals, decimalInfo.scaledDecimals);\n        data.valueRounded = kbn.roundValue(data.value, decimalInfo.decimals);\n      }\n\n      // Add $__name variable for using in prefix or postfix\n      data.scopedVars = _.extend({}, this.panel.scopedVars);\n      data.scopedVars['__name'] = { value: this.series[0].label }; // eslint-disable-line\n    }\n\n    if (this.series && this.series.length > 1 && data.value) {\n      this.getTrendValue(data, this.series[1], data.value);\n    } else {\n      data.trend = {}\n    }\n    console.log(data)\n  }\n\n  getTrendValue(data, series, current) {\n\n    data.trend = {}\n\n    const original = series.stats[this.panel.valueName];\n    // const original = 130.2456;\n    const increase = current - original;\n\n    console.log(current, original, increase)\n\n    let percent = 0;\n    if (original !== 0) {\n      percent = (increase / original) * 100;\n      if (percent > 0) {\n        data.trend.sign = 1;\n      } else if (percent < 0) {\n        data.trend.sign = -1;\n      } else {\n        data.trend.sign = 0;\n      }\n    } else {\n      if (current > 0) {\n        data.trend.sign = 1;\n      } else if (current < 0) {\n        data.trend.sign = -1;\n      } else {\n        data.trend.sign = 0;\n      }      \n    }\n\n\n    data.trend.percent = Math.abs(parseInt(percent.toFixed(2), 10));\n    data.trend.increase = increase;\n    data.trend.original = original;\n\n    const decimalInfo = this.getDecimalsForValue(increase);\n    const formatFunc = kbn.valueFormats[this.panel.format];\n    data.trend.increaseFormatted = formatFunc(increase, decimalInfo.decimals, decimalInfo.scaledDecimals);\n    data.trend.increaseRounded = kbn.roundValue(increase, decimalInfo.decimals);\n  }\n\n  //\n  // Util\n  //\n  setUnitFormat(subItem) {\n    this.panel.format = subItem.value;\n    this.refresh();\n  }\n\n  getDecimalsForValue(value) {\n    if (_.isNumber(this.panel.decimals)) {\n      return { decimals: this.panel.decimals, scaledDecimals: null };\n    }\n\n    const delta = value / 2;\n    let dec = -Math.floor(Math.log(delta) / Math.LN10);\n\n    const magn = Math.pow(10, -dec);\n    const norm = delta / magn; // norm is between 1.0 and 10.0\n    let size = null;\n\n    if (norm < 1.5) {\n      size = 1;\n    } else if (norm < 3) {\n      size = 2;\n      // special case for 2.5, requires an extra decimal\n      if (norm > 2.25) {\n        size = 2.5;\n        ++dec;\n      }\n    } else if (norm < 7.5) {\n      size = 5;\n    } else {\n      size = 10;\n    }\n\n    size *= magn;\n\n    // reduce starting decimals if not needed\n    if (Math.floor(value) === value) {\n      dec = 0;\n    }\n\n    const result = {};\n    result.decimals = Math.max(0, dec);\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\n\n    return result;\n  }\n\n  //\n  // Rendering\n  //\n  link(scope, elem) {\n    this.events.on('render', () => {\n      const $panelContainer = elem.find('.panel-container');\n      const $valueContainer = elem.find('.trend-panel-value-container > span.trend-panel-value');\n      const $prefixContainer = elem.find('.trend-panel-value-container > span.trend-panel-prefix');\n      const $trendContainer = elem.find('.trend-panel-trend-container');\n      const $signContainer = elem.find('.trend-panel-trend-container > span.trend-panel-sign');\n      const $unitContainer = elem.find('.trend-panel-trend-container > span.trend-panel-unit');\n      const $diffContainer = elem.find('.trend-panel-trend-container > span.trend-panel-diff');\n      const $trendValueContainer = elem.find('.trend-panel-trend-container > span.trend-panel-trend-value');\n\n      if (this.data.valueFormatted) {\n        $prefixContainer.html(this.panel.prefix);\n        $prefixContainer.css('font-size', this.panel.prefixFontSize);\n\n        $valueContainer.html(this.data.valueFormatted);\n        $valueContainer.removeAttr('style');\n        $valueContainer.css('font-size', this.panel.valueFontSize);\n      } else {\n        $valueContainer.html('loading...');\n        $valueContainer.css({\n            'opacity': 0.2,\n            'font-size': '30%',\n            'font-weight': 10\n          });\n      }\n\n      if (this.panel.trend.show && \n          this.data.trend.hasOwnProperty('percent') && \n          this.data.trend.hasOwnProperty('sign')) {\n        $signContainer.html(this.panel.trend.sign[this.data.trend.sign + 1]);\n        $signContainer.css('font-size', this.panel.trend.signFontSize);\n        $trendValueContainer.html((this.data.trend.original === 0)? '&nbsp;': this.data.trend.percent);\n        $trendValueContainer.css('font-size', this.panel.trend.valueFontSize);\n        $unitContainer.html((this.data.trend.original === 0)? '&nbsp;': '%');\n        $unitContainer.css('font-size', this.panel.trend.unitFontSize);\n\n        $trendContainer.css('color', this.panel.trend.colors[this.data.trend.sign + 1]);\n\n        if (this.panel.trend.showDiff && \n            this.data.trend.increaseRounded && \n            this.data.trend.increaseRounded !== 0) {\n          $diffContainer.html((this.data.trend.increaseRounded > 0) ? '+' + this.data.trend.increaseRounded : '-' + this.data.trend.increaseRounded);\n          $diffContainer.css({\n            'background-color': this.panel.trend.colors[this.data.trend.sign + 1],\n            'color': '#cccccc',\n            'font-size': '30%',\n            'margin-left': '15px',\n            'padding': '2px 4px',\n            'border-radius': '5px',\n          });\n        } else {\n          $diffContainer.html('');\n          $diffContainer.removeAttr('style');\n        }\n      } else {\n        $signContainer.html('');\n        $signContainer.removeAttr('style');\n        $trendValueContainer.html('');\n        $trendValueContainer.removeAttr('style');\n        $unitContainer.html('');\n        $unitContainer.removeAttr('style');\n        $diffContainer.html('&nbsp;');\n        $diffContainer.removeAttr('style');\n\n      }\n\n      if (this.panel.bgColor) {\n        $panelContainer.css('background-color', this.panel.bgColor);\n      } else {\n        $panelContainer.css('background-color', 'transparent');\n      }\n    });\n  }\n}\n\nTrendCtrl.templateUrl = 'module.html';\n"]}