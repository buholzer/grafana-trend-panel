{"version":3,"sources":["../src/trend_ctrl.js"],"names":["MetricsPanelCtrl","_","kbn","TimeSeries","TrendCtrl","$scope","$injector","$rootScope","panelDefaults","bgColor","prefix","postfix","valueName","format","prefixFontSize","valueFontSize","postfixFontSize","trend","show","signFontSize","unitFontSize","showDiff","colors","sign","colorInBackground","thresholds","defaultsDeep","panel","events","on","onDataReceived","bind","onDataError","onInitEditMode","onPanelTeardown","render","data","percent","valueNameOptions","value","text","err","console","log","dataList","series","map","seriesHandler","setValues","fontSizes","unitFormats","getUnitFormats","addEditorTab","$timeout","cancel","nextTickPromise","panelColorIndex","color","seriesData","datapoints","alias","target","flotpairs","getFlotPairs","nullPointMode","length","lastPoint","last","lastValue","isArray","valueRounded","valueFormatted","isString","escape","formatFunc","valueFormats","stats","decimalInfo","getDecimalsForValue","decimals","scaledDecimals","roundValue","scopedVars","extend","label","getTrendValue","current","original","increase","numDecimals","Math","abs","parseFloat","round","toFixed","percentFull","percentDecimals","pow","increaseFormatted","increaseRounded","subItem","refresh","isNumber","delta","dec","floor","LN10","magn","norm","size","result","max","tmp","isFinite","split","Number","strVale","trim","scope","elem","$panelContainer","find","$valueContainer","$prefixContainer","$postfixContainer","$trendContainer","$signContainer","$unitContainer","$diffContainer","$trendValueContainer","$trendDigitContainer","html","css","hasOwnProperty","backgroundColor","getColorForValue","foregroundColor","removeAttr","templateUrl"],"mappings":"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","file":"trend_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport TimeSeries from 'app/core/time_series';\r\n// import rendering from './rendering';\r\nimport './css/trend-panel.css!';\r\n\r\nexport class TrendCtrl extends MetricsPanelCtrl {\r\n\r\n  constructor($scope, $injector, $rootScope) {\r\n    super($scope, $injector);\r\n    this.$rootScope = $rootScope;\r\n\r\n    const panelDefaults = {\r\n      bgColor: null,\r\n      prefix: '',\r\n      postfix: '',\r\n      valueName: 'avg',\r\n      format: 'none',\r\n      prefixFontSize: '50%',\r\n      valueFontSize: '80%',\r\n      postfixFontSize: '50%',\r\n      trend: {\r\n        show: true,\r\n        valueFontSize: '80%',\r\n        signFontSize: '70%',\r\n        unitFontSize: '50%',\r\n        showDiff: false,\r\n        colors: ['#d44a3a', '#e5ac0e', '#299c46'],\r\n        sign: ['▼', '▶', '▲'],\r\n        colorInBackground: false,\r\n        thresholds : \"0,0\"\r\n      },\r\n    };\r\n\r\n    _.defaultsDeep(this.panel, panelDefaults);\r\n\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n    this.events.on('data-error', this.onDataError.bind(this));\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\r\n    this.events.on('panel-initialized', this.render.bind(this));\r\n\r\n    this.data = {trend: {percent: 0, sign: 0}};\r\n\r\n    this.valueNameOptions = [\r\n      { value: 'min', text: 'Min' },\r\n      { value: 'max', text: 'Max' },\r\n      { value: 'avg', text: 'Average' },\r\n      { value: 'current', text: 'Current' },\r\n      { value: 'total', text: 'Total' },\r\n      { value: 'name', text: 'Name' },\r\n      { value: 'first', text: 'First' },\r\n      { value: 'delta', text: 'Delta' },\r\n      { value: 'diff', text: 'Difference' },\r\n      { value: 'range', text: 'Range' },\r\n      { value: 'last_time', text: 'Time of last point' },\r\n    ];\r\n  }\r\n\r\n  //\r\n  // Event Handling\r\n  //\r\n  onDataError(err) {\r\n    console.log(err);\r\n    this.onDataReceived([]);\r\n  }\r\n\r\n  onDataReceived(dataList) {\r\n    const data = {};\r\nconsole.log('onDataReceived()', dataList)\r\n    this.series = dataList.map(this.seriesHandler.bind(this));\r\n    this.setValues(data);\r\n\r\n    this.data = data;\r\n    this.render();\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.fontSizes = ['20%', '30%', '50%', '70%', '80%', '100%', '110%', '120%', '150%', '170%', '200%'];\r\n    this.unitFormats = kbn.getUnitFormats();\r\n    this.addEditorTab('Options', 'public/plugins/trend-panel/editor.html', 2);\r\n  }\r\n\r\n  onPanelTeardown() {\r\n    this.$timeout.cancel(this.nextTickPromise);\r\n  }\r\n\r\n  onTrendColorChange(panelColorIndex) {\r\n    return color => {\r\n      this.panel.trend.colors[panelColorIndex] = color;\r\n      this.render();\r\n    };\r\n  }\r\n\r\n  //\r\n  // Data Handling\r\n  //\r\n  seriesHandler(seriesData) {\r\n    const series = new TimeSeries({\r\n      datapoints: seriesData.datapoints || [],\r\n      alias: seriesData.target,\r\n    });\r\n\r\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\r\n    return series;\r\n  }\r\n\r\n  setValues(data) {\r\n    data.flotpairs = [];\r\n\r\n    // console.log(`${this.panel.prefix} > setValues()`)\r\n    // console.log(this.series)\r\n\r\n    if (this.series && this.series.length > 0) {\r\n      const lastPoint = _.last(this.series[0].datapoints);\r\n      const lastValue = _.isArray(lastPoint) ? lastPoint[0] : null;\r\n\r\n      if (this.panel.valueName === 'name') {\r\n        data.value = 0;\r\n        data.valueRounded = 0;\r\n        data.valueFormatted = this.series[0].alias;\r\n      } else if (_.isString(lastValue)) {\r\n        data.value = 0;\r\n        data.valueFormatted = _.escape(lastValue);\r\n        data.valueRounded = 0;\r\n      } else if (this.panel.valueName === 'last_time') {\r\n        const formatFunc = kbn.valueFormats[this.panel.format];\r\n        data.value = lastPoint[1];\r\n        data.valueRounded = data.value;\r\n        data.valueFormatted = formatFunc(data.value, 0, 0);\r\n      } else {\r\n        data.value = this.series[0].stats[this.panel.valueName];\r\n        data.flotpairs = this.series[0].flotpairs;\r\n\r\n        const decimalInfo = this.getDecimalsForValue(data.value);\r\n        const formatFunc = kbn.valueFormats[this.panel.format];\r\n        data.valueFormatted = formatFunc(data.value, decimalInfo.decimals, decimalInfo.scaledDecimals);\r\n        data.valueRounded = kbn.roundValue(data.value, decimalInfo.decimals);\r\n      }\r\n\r\n      // Add $__name variable for using in prefix or postfix\r\n      data.scopedVars = _.extend({}, this.panel.scopedVars);\r\n      data.scopedVars['__name'] = { value: this.series[0].label }; // eslint-disable-line\r\n    }\r\n\r\n    if (this.series && this.series.length > 1 && data.value) {\r\n      this.getTrendValue(data, this.series[1], data.value);\r\n    } else {\r\n      data.trend = {}\r\n    }\r\n\r\n    console.log(`${this.panel.prefix} > trend`)\r\n    console.log(data.trend)\r\n  }\r\n\r\n  getTrendValue(data, series, current) {\r\n\r\n    data.trend = {}\r\n    const original = series.stats[this.panel.valueName];\r\n    // const original = 130.2456;\r\n    const increase = current - original;\r\n\r\n    // console.log(current, original, increase)\r\n\r\n    let percent = 0;\r\n    if (original !== 0) {\r\n      percent = (increase / original) * 100;\r\n      if (percent > 0) {\r\n        data.trend.sign = 1;\r\n      } else if (percent < 0) {\r\n        data.trend.sign = -1;\r\n      } else {\r\n        data.trend.sign = 0;\r\n      }\r\n    } else {\r\n      if (current > 0) {\r\n        data.trend.sign = 1;\r\n      } else if (current < 0) {\r\n        data.trend.sign = -1;\r\n      } else {\r\n        data.trend.sign = 0;\r\n      }      \r\n    }\r\n\r\n    const numDecimals = 2;\r\n    data.trend.percent = Math.abs(parseFloat(Math.round(percent * 100) / 100).toFixed(numDecimals));\r\n    data.trend.percentFull = data.trend.percent | 0;\r\n    data.trend.percentDecimals = Math.round((data.trend.percent % 1).toFixed(numDecimals) * Math.pow(10, numDecimals))\r\n    // console.log('>> percent', data.trend.percent, data.trend.percentFull, data.trend.percentDecimals);\r\n\r\n    data.trend.increase = increase;\r\n    data.trend.original = original;\r\n\r\n    const decimalInfo = this.getDecimalsForValue(increase);\r\n    const formatFunc = kbn.valueFormats[this.panel.format];\r\n    data.trend.increaseFormatted = formatFunc(increase, decimalInfo.decimals, decimalInfo.scaledDecimals);\r\n    data.trend.increaseRounded = kbn.roundValue(increase, decimalInfo.decimals);\r\n  }\r\n\r\n  //\r\n  // Util\r\n  //\r\n  setUnitFormat(subItem) {\r\n    this.panel.format = subItem.value;\r\n    this.refresh();\r\n  }\r\n\r\n  getDecimalsForValue(value) {\r\n    if (_.isNumber(this.panel.decimals)) {\r\n      return { decimals: this.panel.decimals, scaledDecimals: null };\r\n    }\r\n\r\n    const delta = value / 2;\r\n    let dec = -Math.floor(Math.log(Math.abs(delta)) / Math.LN10);\r\n\r\n    const magn = Math.pow(10, -dec);\r\n    const norm = delta / magn; // norm is between 1.0 and 10.0\r\n    let size = null;\r\n\r\n    if (norm < 1.5) {\r\n      size = 1;\r\n    } else if (norm < 3) { \r\n      size = 2;\r\n      // special case for 2.5, requires an extra decimal\r\n      if (norm > 2.25) {\r\n        size = 2.5;\r\n        ++dec;\r\n      }\r\n    } else if (norm < 7.5) {\r\n      size = 5;\r\n    } else {\r\n      size = 10;\r\n    }\r\n\r\n    size *= magn;\r\n\r\n    // reduce starting decimals if not needed\r\n    if (Math.floor(value) === value) {\r\n      dec = 0;\r\n    }\r\n\r\n    const result = {};\r\n    result.decimals = Math.max(0, dec);\r\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\r\n\r\n    return result;\r\n  }\r\n\r\n  invertColorOrder() {\r\n    const tmp = this.panel.trend.colors[0];\r\n    this.panel.trend.colors[0] = this.panel.trend.colors[2];\r\n    this.panel.trend.colors[2] = tmp;\r\n    this.render();\r\n  }\r\n\r\n  getColorForValue() {\r\n    if (!_.isFinite(this.data.trend.percent)) {\r\n      return null;\r\n    }\r\n\r\n    var value = this.data.trend.percent * this.data.trend.sign;\r\n    \r\n    var thresholds = this.panel.trend.thresholds.split(',').map(strVale => {\r\n      return Number(strVale.trim());\r\n    });\r\n\r\n    if (value < thresholds[0]){\r\n      return this.panel.trend.colors[0];\r\n    }\r\n    else if (value >= thresholds[0] && value <= thresholds[1]){\r\n      return this.panel.trend.colors[1];\r\n    }\r\n    else{\r\n      return this.panel.trend.colors[2];\r\n    }\r\n  }\r\n\r\n  //\r\n  // Rendering\r\n  //\r\n  link(scope, elem) {\r\n    this.events.on('render', () => {\r\n      const $panelContainer = elem.find('.trend-panel-value-container');\r\n      const $valueContainer = elem.find('.trend-panel-value-container > span.trend-panel-value');\r\n      const $prefixContainer = elem.find('.trend-panel-value-container > span.trend-panel-prefix');\r\n      const $postfixContainer = elem.find('.trend-panel-value-container > span.trend-panel-postfix');\r\n      const $trendContainer = elem.find('.trend-panel-trend-container');\r\n      const $signContainer = elem.find('.trend-panel-trend-container > span.trend-panel-sign');\r\n      const $unitContainer = elem.find('.trend-panel-trend-container > span.trend-panel-unit');\r\n      const $diffContainer = elem.find('.trend-panel-trend-container > span.trend-panel-diff');\r\n      const $trendValueContainer = elem.find('.trend-panel-trend-container > span.trend-panel-trend-value');\r\n      const $trendDigitContainer = elem.find('.trend-panel-trend-container > span.trend-panel-trend-digits');\r\n\r\n      $prefixContainer.html(this.panel.prefix);\r\n      $postfixContainer.html(this.panel.postfix);\r\n      $prefixContainer.css('font-size', this.panel.prefixFontSize);\r\n      $valueContainer.css('font-size', this.panel.valueFontSize);\r\n\r\n      if (this.data.valueFormatted) {\r\n        $valueContainer.html(this.data.valueFormatted);\r\n      } else {\r\n        $valueContainer.html('0');\r\n        // $valueContainer.html('loading...');\r\n        // $valueContainer.css({\r\n        //     'opacity': 0.2,\r\n        //     'font-size': '30%',\r\n        //     'font-weight': 10\r\n        //   });\r\n      }\r\n\r\n      if (this.panel.trend.show && \r\n          this.data.trend.hasOwnProperty('percent') && \r\n          this.data.trend.hasOwnProperty('sign')) {\r\n        $signContainer.html(this.panel.trend.sign[this.data.trend.sign + 1]);\r\n        $signContainer.css('font-size', this.panel.trend.signFontSize);\r\n        $trendValueContainer.html((this.data.trend.original === 0)? '&nbsp;': this.data.trend.percentFull);\r\n        $trendValueContainer.css('font-size', this.panel.trend.valueFontSize);\r\n        $trendDigitContainer.html((this.data.trend.percentDecimals && this.data.trend.percentDecimals !== 0)? '.' + this.data.trend.percentDecimals : '');\r\n\t\t    $trendDigitContainer.css('font-size', this.panel.trend.valueFontSize);\r\n        $unitContainer.html((this.data.trend.original === 0)? '&nbsp;': '%');\r\n        $unitContainer.css('font-size', this.panel.trend.unitFontSize);\r\n        var backgroundColor =  this.panel.trend.colorInBackground ? this.getColorForValue() : '#cccccc';\r\n        var foregroundColor = this.panel.trend.colorInBackground ? '#cccccc' : this.getColorForValue();\r\n\r\n        $trendContainer.removeAttr('style');\r\n        if (this.panel.trend.colorInBackground){\r\n          $trendContainer.css('background-color', backgroundColor);\r\n        }\r\n        else{\r\n          $trendContainer.css('color', foregroundColor);\r\n        }\r\n        \r\n        if (this.panel.trend.showDiff && \r\n            this.data.trend.increaseRounded && \r\n            this.data.trend.increaseRounded !== 0) {\r\n          $diffContainer.html((this.data.trend.increaseRounded > 0) ? '+' + this.data.trend.increaseFormatted : this.data.trend.increaseFormatted);\r\n          $diffContainer.css({\r\n            'background-color': foregroundColor,\r\n            'color': backgroundColor,\r\n            'font-size': '30%',\r\n            'margin-left': '15px',\r\n            'padding': '2px 4px',\r\n            'border-radius': '5px',\r\n          });\r\n        } else {\r\n          $diffContainer.html('');\r\n          $diffContainer.removeAttr('style');\r\n        }\r\n      } else {\r\n        $signContainer.html('');\r\n        $signContainer.removeAttr('style');\r\n        if (this.panel.trend.show){\r\n          $trendValueContainer.html(\"Provide query 'B' to see trend\");\r\n        }\r\n        else{\r\n          $trendValueContainer.html('');\r\n        }\r\n        $trendValueContainer.removeAttr('style');\r\n        $unitContainer.html('');\r\n        $unitContainer.removeAttr('style');\r\n        $diffContainer.html('&nbsp;');\r\n        $diffContainer.removeAttr('style');\r\n\r\n      }\r\n\r\n      if (this.panel.bgColor) {\r\n        $panelContainer.css('background-color', this.panel.bgColor);\r\n      } else {\r\n        $panelContainer.css('background-color', 'transparent');\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nTrendCtrl.templateUrl = 'module.html';\r\n"]}